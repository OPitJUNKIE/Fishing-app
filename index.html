<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Upstate NY Bite Likelihood</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#09131e">
<style>
  :root{--bg:#09131e;--card:#0f1c2b;--ink:#eaf1fb;--muted:#b5c1d6;--accent:#7ad3ff;--line:#213145}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:980px;margin:0 auto;padding:16px 14px 36px}
  header{display:flex;align-items:center;justify-content:center;gap:10px;margin:4px 0 12px}
  header img{width:36px;height:36px;border-radius:8px}
  h1{font-size:1.15rem;margin:0}
  .tabs{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .tab{padding:10px 14px;border:1px solid var(--line);border-radius:999px;background:#0b1725;color:var(--ink);cursor:pointer}
  .tab.active{background:var(--accent);color:#082334;font-weight:700}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px 12px 12px;box-shadow:0 6px 24px rgba(0,0,0,.35)}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  label{font-size:.86rem;color:var(--muted);margin-bottom:4px;display:block}
  select,input[type="number"]{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3c54;background:#0b1725;color:var(--ink);font-size:1rem;outline:none}
  select:focus,input[type="number"]:focus{border-color:var(--accent)}
  .row{display:flex;gap:10px;align-items:center}
  input[type="checkbox"]{width:22px;height:22px}
  .btn{width:100%;margin-top:12px;padding:14px;border-radius:12px;background:var(--accent);color:#082334;border:0;font-weight:700;font-size:1.03rem}
  .result{margin-top:14px;padding:16px;border-radius:14px;background:#0c1826;border:1px solid var(--line)}
  .score{font-size:2.3rem;font-weight:800;margin:0}
  .verdict{font-size:1.05rem;margin:4px 0 0;color:var(--muted)}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;margin-left:8px;border:1px solid rgba(255,255,255,.15)}
  .bad{background:rgba(239,83,80,.15);color:#ffb3ae;border-color:rgba(239,83,80,.3)}
  .fair{background:rgba(255,152,0,.14);color:#ffd7a6;border-color:rgba(255,152,0,.32)}
  .good{background:rgba(77,208,225,.14);color:#b8f2f7;border-color:rgba(77,208,225,.32)}
  .great{background:rgba(76,175,80,.14);color:#c8f2c9;border-color:rgba(76,175,80,.32)}
  .peak{background:rgba(156,39,176,.16);color:#edc6f4;border-color:rgba(156,39,176,.32)}
  details{margin-top:10px}
  summary{cursor:pointer;color:var(--muted)}
  .tiny{font-size:.8rem;color:var(--muted)}
  .footer{margin-top:18px;text-align:center;color:var(--muted);font-size:.85rem}
  .hint{margin:8px 0 0;font-size:.8rem;color:var(--muted)}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill2{padding:6px 10px;border-radius:999px;background:#0b1725;border:1px solid var(--line)}
  .list{margin:8px 0 0;padding:0}
  .list li{list-style:none;margin:6px 0;padding:8px;border:1px solid var(--line);border-radius:10px;background:#0b1725}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <img src="bite_app_icon_512.png" alt="icon"><h1>Upstate NY Bite Likelihood</h1>
  </header>
  <div class="tabs">
    <button class="tab active" data-tab="calc1">Weather Calculator</button>
    <button class="tab" data-tab="calc2">Waterbody‑Adjusted</button>
    <button class="tab" data-tab="outlook">Forecast & Alerts</button>
  </div>
  <div id="calc1" class="card">
    <div class="grid">
      <div><label for="c1_species">Species</label><select id="c1_species">
        <option value="trout">Trout</option><option value="salmon">Salmon</option>
        <option value="bass" selected>Bass (LM/SM)</option><option value="walleye">Walleye</option>
        <option value="pike">Northern Pike</option><option value="musky">Musky</option>
        <option value="panfish">Panfish</option></select></div>
      <div><label for="c1_temp">Water Temp (°F)</label><input id="c1_temp" type="number" inputmode="decimal" placeholder="e.g., 66" min="32" max="90"></div>
      <div><label for="c1_baro">Barometric Trend</label><select id="c1_baro">
        <option value="rapid_falling">Rapid falling (pre-front)</option><option value="falling">Gentle falling</option>
        <option value="stable" selected>Stable</option><option value="rising">Gentle rising</option>
        <option value="rapid_rising">Rapid rising (post-front)</option></select></div>
      <div><label for="c1_sky">Light / Sky</label><select id="c1_sky">
        <option value="overcast">Overcast / thin clouds</option><option value="mixed" selected>Mixed clouds</option>
        <option value="dawn_dusk">Dawn / Dusk</option><option value="night">Night</option>
        <option value="sunny_midday">Bright & sunny (midday)</option></select></div>
      <div><label for="c1_wind">Wind (mph)</label><input id="c1_wind" type="number" inputmode="numeric" placeholder="e.g., 10" min="0" max="60"></div>
      <div><label for="c1_precip">Precip / Runoff</label><select id="c1_precip">
        <option value="none" selected>None</option><option value="light">Light rain / recent drizzle</option>
        <option value="heavy">Heavy rain / muddy surge</option></select></div>
      <div><label for="c1_season">Season</label><select id="c1_season">
        <option value="spring">Spring (Apr–May)</option><option value="summer" selected>Summer (Jun–Aug)</option>
        <option value="fall">Fall (Sep–Nov)</option><option value="winter">Winter (Dec–Mar)</option></select></div>
      <div><label for="c1_tod">Time of Day</label><select id="c1_tod">
        <option value="dawn">Dawn</option><option value="morning" selected>Morning</option><option value="midday">Midday</option>
        <option value="evening">Evening</option><option value="dusk">Dusk</option><option value="night">Night</option></select></div>
    </div>
    <div class="row" style="margin-top:6px"><input type="checkbox" id="c1_windward"><label for="c1_windward">Fishing a windward bank / point</label></div>
    <button class="btn" id="c1_calc">Calculate</button>
    <div class="result" id="c1_result" hidden><p class="score" id="c1_score">—</p><p class="verdict" id="c1_verdict">Tap “Calculate”</p><details><summary>Show factor breakdown</summary><div id="c1_breakdown" class="tiny"></div></details></div>
  </div>

  <div id="calc2" class="card" style="display:none">
    <div class="grid">
      <div><label for="c2_water">Waterbody</label><select id="c2_water"></select><div class="hint">Rochester‑area waters.</div></div>
      <div><label for="c2_species">Target Species</label><select id="c2_species">
        <option value="trout">Trout/Salmon (salmonids)</option><option value="bass" selected>Bass (LM/SM)</option>
        <option value="walleye">Walleye</option><option value="pike">Northern Pike / Pickerel</option>
        <option value="musky">Muskellunge</option><option value="perch">Yellow Perch</option>
        <option value="crappie">Crappie</option><option value="panfish">Sunfish</option><option value="catfish">Catfish/Bullhead</option></select></div>
      <div><label for="c2_temp">Water Temp (°F)</label><input id="c2_temp" type="number" inputmode="decimal" placeholder="e.g., 66" min="32" max="90"></div>
      <div><label for="c2_baro">Barometric Trend</label><select id="c2_baro">
        <option value="rapid_falling">Rapid falling (pre-front)</option><option value="falling">Gentle falling</option>
        <option value="stable" selected>Stable</option><option value="rising">Gentle rising</option>
        <option value="rapid_rising">Rapid rising (post-front)</option></select></div>
      <div><label for="c2_sky">Light / Sky</label><select id="c2_sky">
        <option value="overcast">Overcast / thin clouds</option><option value="mixed" selected>Mixed clouds</option>
        <option value="dawn_dusk">Dawn / Dusk</option><option value="night">Night</option>
        <option value="sunny_midday">Bright & sunny (midday)</option></select></div>
      <div><label for="c2_wind">Wind (mph)</label><input id="c2_wind" type="number" inputmode="numeric" placeholder="e.g., 10" min="0" max="60"></div>
      <div><label for="c2_precip">Precip / Runoff</label><select id="c2_precip">
        <option value="none" selected>None</option><option value="light">Light rain / recent drizzle</option>
        <option value="heavy">Heavy rain / muddy surge</option></select></div>
      <div><label for="c2_season">Season</label><select id="c2_season">
        <option value="spring">Spring (Apr–May)</option><option value="summer" selected>Summer (Jun–Aug)</option>
        <option value="fall">Fall (Sep–Nov)</option><option value="winter">Winter (Dec–Mar)</option></select></div>
      <div><label for="c2_tod">Time of Day</label><select id="c2_tod">
        <option value="dawn">Dawn</option><option value="morning" selected>Morning</option><option value="midday">Midday</option>
        <option value="evening">Evening</option><option value="dusk">Dusk</option><option value="night">Night</option></select></div>
    </div>
    <div class="row" style="margin-top:6px"><input type="checkbox" id="c2_windward"><label for="c2_windward">Fishing a windward bank / point</label></div>
    <button class="btn" id="c2_calc">Calculate</button>
    <div class="result" id="c2_result" hidden><p class="score" id="c2_score">—</p><p class="verdict" id="c2_verdict">Tap “Calculate”</p><details><summary>Show factor breakdown</summary><div id="c2_breakdown" class="tiny"></div></details></div>
  </div>

  <div id="outlook" class="card" style="display:none">
    <div class="flex"><div class="pill2">Forecast provider: Open‑Meteo</div><div class="pill2">Location: Rochester area</div></div>
    <p class="tiny">Note: iOS PWAs can’t push background notifications without a server. Use this tab to check on demand, or add a Calendar reminder.</p>
    <div class="row"><label for="threshold" style="flex:1 1 auto">Alert threshold (score ≥)</label><input id="threshold" type="number" min="0" max="100" step="1" value="65" style="max-width:120px"><button class="btn" id="checkNow" style="flex:1 1 100%">Check Tomorrow & Next 24h</button></div>
    <ul class="list" id="out_list"></ul>
    <div class="row" style="margin-top:8px"><button class="btn" id="addCalendar">Add 7pm Daily Reminder</button></div>
  </div>

  <div class="footer">Install: Share → Add to Home Screen. Offline-ready via service worker. Weather by Open‑Meteo.</div>
</div>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(console.error); });
}
const bands = {"trout":{"ideal":[50,65],"usable":[44,49,66,70]},"salmon":{"ideal":[50,65],"usable":[44,49,66,70]},"bass":{"ideal":[65,75],"usable":[58,64,76,82]},"walleye":{"ideal":[55,68],"usable":[48,54,69,74]},"pike":{"ideal":[60,70],"usable":[52,59,71,76]},"musky":{"ideal":[60,70],"usable":[52,59,71,76]},"panfish":{"ideal":[65,75],"usable":[58,64,76,82]},"perch":{"ideal":[55,68],"usable":[48,54,69,74]},"crappie":{"ideal":[65,75],"usable":[58,64,76,82]},"catfish":{"ideal":[70,80],"usable":[62,69,81,86]}};
function tempPoints(species, t){const b=bands[species]||bands["bass"];const [lo,hi]=b.ideal;const [ulo1,uhi1,ulo2,uhi2]=b.usable;if(t>=lo&&t<=hi)return{pts:40,txt:`Temp in ideal (${lo}–${hi}°F): +40`};if(t>=ulo1&&t<lo){const p=40*(t-ulo1)/(lo-ulo1);return{pts:p,txt:`Temp in cool shoulder (${ulo1}–${lo}°F): +${p.toFixed(1)}`};}if(t>hi&&t<=uhi2){const p=40*(uhi2-t)/(uhi2-hi);return{pts:p,txt:`Temp in warm shoulder (${hi}–${uhi2}°F): +${p.toFixed(1)}`};}return{pts:0,txt:`Temp outside usable: +0`};}
function verdictFrom(score){if(score<25)return{tag:"Poor",cls:"bad"};if(score<50)return{tag:"Fair",cls:"fair"};if(score<70)return{tag:"Good",cls:"good"};if(score<85)return{tag:"Great",cls:"great"};return{tag:"Peak",cls:"peak"};}
function baseScore(species, waterTempF, baroTrend, sky, windMph, precip, season, tod, windward){let pts=0;const lines=[];if(!isNaN(waterTempF)){const t=tempPoints(species,waterTempF);pts+=t.pts;lines.push(t.txt);}else{lines.push("Temp not set: +0");}const baroMap={"rapid_falling":15,"falling":10,"stable":6,"rising":2,"rapid_rising":-5};const bp=(baroMap[baroTrend]||0);pts+=bp;lines.push(`Barometric trend: ${baroTrend.replace("_"," ")}: ${(bp>=0?"+":"")}${bp}`);let skyPts=0;if(sky==="overcast")skyPts=10;else if(sky==="mixed"||sky==="dawn_dusk")skyPts=8;else if(sky==="night")skyPts=(species==="walleye"?8:6);else if(sky==="sunny_midday")skyPts=-5;pts+=skyPts;lines.push(`Light/Sky: ${(skyPts>=0?"+":"")}${skyPts}`);let wPts=0;if(!isNaN(windMph)){if(windMph>=6&&windMph<=15)wPts=10;else if(windMph>=1&&windMph<=5)wPts=5;else if(windMph>22)wPts=-5;}pts+=wPts;lines.push(`Wind ${isNaN(windMph)?"?":windMph} mph: ${(wPts>=0?"+":"")}${wPts}`);if(windward&&!isNaN(windMph)&&windMph>=6&&windMph<=18){pts+=2;lines.push("Windward bank bonus: +2");}let pPts=0;if(precip==="light")pPts=5;else if(precip==="heavy")pPts=-8;if(precip==="heavy"&&species==="pike")pPts=-4;pts+=pPts;lines.push(`Precip/runoff: ${(pPts>=0?"+":"")}${pPts}`);let sPts=0;if(season==="spring"){sPts=(["trout","salmon","walleye","pike","musky"].includes(species))?8:4;}else if(season==="summer"){if(["bass","panfish","crappie","perch"].includes(species))sPts=8;else if(species==="walleye")sPts=6;else if(["trout","salmon"].includes(species))sPts=-6;}else if(season==="fall"){if(["pike","musky","walleye","trout","salmon"].includes(species))sPts=12;else sPts=6;}else if(season==="winter"){if(species==="walleye")sPts=4;else if(["trout","salmon"].includes(species))sPts=2;else sPts=-4;}pts+=sPts;lines.push(`Season alignment: ${(sPts>=0?"+":"")}${sPts}`);const todMap={"dawn":8,"dusk":8,"morning":4,"evening":4,"midday":-4,"night":6};let tPts=todMap[tod]??0;if(tod==="night"&&species==="walleye")tPts=8;pts+=tPts;lines.push(`Time of day: ${(tPts>=0?"+":"")}${tPts}`);const score=Math.max(0,Math.min(100,Math.round(pts)));return{score,lines,verdict:verdictFrom(score)};}
const WATERS=[["Lake Ontario (Rochester Shore)",43.256,-77.596],["Genesee River (Lower)",43.235,-77.609],["Irondequoit Bay",43.225,-77.543],["Braddock Bay",43.302,-77.691],["Long Pond (Greece)",43.276,-77.681],["Cranberry Pond",43.289,-77.686],["Buck Pond",43.294,-77.685],["Round Pond (Greece)",43.303,-77.673],["Durand Lake",43.238,-77.557],["Hundred Acre Pond (Mendon)",43.005,-77.559],["Deep Pond (Mendon)",43.008,-77.566],["Round Pond (Mendon)",43.012,-77.563],["Quaker Pond (Mendon)",43.021,-77.564],["Black Creek (Monroe)",43.103,-77.755],["Oatka Creek",42.997,-77.858],["Salmon Creek (Monroe)",43.324,-77.709],["Conesus Lake",42.746,-77.704],["Honeoye Lake",42.779,-77.512],["Hemlock Lake",42.754,-77.590],["Canadice Lake",42.704,-77.603],["Sodus Bay",43.271,-76.991],["Canandaigua Lake",42.800,-77.286]];
const A=12,C2=6,P2=2,R=-4,N=-8;
const PREV={"Lake Ontario (Rochester Shore)":{trout:C2,bass:C2,walleye:P2,pike:P2,musky:R,perch:C2,crappie:P2,panfish:P2,catfish:P2},"Genesee River (Lower)":{trout:"seasonal",bass:C2,walleye:P2,pike:P2,musky:N,perch:C2,crappie:P2,panfish:C2,catfish:C2},"Irondequoit Bay":{trout:R,bass:A,walleye:C2,pike:C2,musky:N,perch:A,crappie:C2,panfish:A,catfish:P2},"Braddock Bay":{trout:R,bass:C2,walleye:P2,pike:C2,musky:N,perch:C2,crappie:P2,panfish:C2,catfish:P2},"Long Pond (Greece)":{trout:N,bass:C2,walleye:P2,pike:C2,musky:N,perch:C2,crappie:P2,panfish:C2,catfish:P2},"Cranberry Pond":{trout:N,bass:C2,walleye:P2,pike:C2,musky:N,perch:C2,crappie:P2,panfish:C2,catfish:P2},"Buck Pond":{trout:N,bass:C2,walleye:P2,pike:C2,musky:N,perch:C2,crappie:P2,panfish:C2,catfish:P2},"Round Pond (Greece)":{trout:N,bass:C2,walleye:N,pike:C2,musky:N,perch:C2,crappie:P2,panfish:C2,catfish:P2},"Durand Lake":{trout:N,bass:C2,walleye:N,pike:R,musky:N,perch:P2,crappie:C2,panfish:C2,catfish:P2},"Hundred Acre Pond (Mendon)":{trout:N,bass:P2,walleye:N,pike:R,musky:N,perch:P2,crappie:P2,panfish:C2,catfish:P2},"Deep Pond (Mendon)":{trout:N,bass:P2,walleye:N,pike:R,musky:N,perch:P2,crappie:P2,panfish:C2,catfish:P2},"Round Pond (Mendon)":{trout:N,bass:P2,walleye:N,pike:R,musky:N,perch:P2,crappie:P2,panfish:C2,catfish:P2},"Quaker Pond (Mendon)":{trout:N,bass:P2,walleye:N,pike:R,musky:N,perch:P2,crappie:P2,panfish:C2,catfish:P2},"Black Creek (Monroe)":{trout:R,bass:C2,walleye:N,pike:C2,musky:N,perch:P2,crappie:P2,panfish:C2,catfish:C2},"Oatka Creek":{trout:A,bass:P2,walleye:N,pike:P2,musky:N,perch:P2,crappie:P2,panfish:P2,catfish:P2},"Salmon Creek (Monroe)":{trout:"seasonal",bass:P2,walleye:N,pike:P2,musky:N,perch:P2,crappie:P2,panfish:P2,catfish:P2},"Conesus Lake":{trout:R,bass:A,walleye:C2,pike:C2,musky:N,perch:C2,crappie:P2,panfish:A,catfish:C2},"Honeoye Lake":{trout:N,bass:A,walleye:C2,pike:C2,musky:N,perch:C2,crappie:C2,panfish:A,catfish:P2},"Hemlock Lake":{trout:C2,bass:C2,walleye:N,pike:C2,musky:N,perch:P2,crappie:P2,panfish:C2,catfish:P2},"Canadice Lake":{trout:C2,bass:C2,walleye:N,pike:C2,musky:N,perch:P2,crappie:P2,panfish:C2,catfish:P2},"Sodus Bay":{trout:2,bass:12,walleye:6,pike:6,musky:-4,perch:12,crappie:6,panfish:12,catfish:2},"Canandaigua Lake":{trout:12,bass:6,walleye:2,pike:-4,musky:-8,perch:6,crappie:2,panfish:2,catfish:2}};
function seasonalBoost(water,species,season){if(species!=="trout")return 0;if(water==="Genesee River (Lower)"||water==="Salmon Creek (Monroe)"){if(["fall","winter","spring"].includes(season))return 8;}return 0;}
function prevalencePoints(water,species,season){const map=PREV[water]||{};let v=map[species];if(v==="seasonal")v=4;return (v||0)+seasonalBoost(water,species,season);}
function withWaterbody(species,water,base,season){return Math.max(0,Math.min(100,Math.round(base+prevalencePoints(water,species,season))));}
function showScore(prefix,score,lines){const v=verdictFrom(score);document.getElementById(prefix+"_result").hidden=false;document.getElementById(prefix+"_score").textContent=score;document.getElementById(prefix+"_verdict").innerHTML=`Verdict: <span class="pill ${v.cls}">${v.tag}</span>`;document.getElementById(prefix+"_breakdown").innerHTML=lines.map(x=>'• '+x).join('<br>');const el=document.getElementById(prefix+"_score");el.style.transition="color .3s ease";el.style.color=(v.cls==="bad")?"#ef9a9a":(v.cls==="fair")?"#ffd54f":(v.cls==="good")?"#80deea":(v.cls==="great")?"#a5d6a7":"#e1bee7";}
document.querySelectorAll('.tab').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');const t=btn.dataset.tab;document.getElementById('calc1').style.display=(t==='calc1')?'block':'none';document.getElementById('calc2').style.display=(t==='calc2')?'block':'none';document.getElementById('outlook').style.display=(t==='outlook')?'block':'none';});});
const waterSel=document.getElementById('c2_water');[
  "Lake Ontario (Rochester Shore)","Genesee River (Lower)","Irondequoit Bay","Braddock Bay","Long Pond (Greece)","Cranberry Pond","Buck Pond","Round Pond (Greece)","Durand Lake","Hundred Acre Pond (Mendon)","Deep Pond (Mendon)","Round Pond (Mendon)","Quaker Pond (Mendon)","Black Creek (Monroe)","Oatka Creek","Salmon Creek (Monroe)","Conesus Lake","Honeoye Lake","Hemlock Lake","Canadice Lake","Sodus Bay","Canandaigua Lake"
].forEach(w=>{const o=document.createElement('option');o.textContent=w;waterSel.appendChild(o);});
document.getElementById('c1_calc').addEventListener('click',()=>{const sp=document.getElementById('c1_species').value;const temp=parseFloat(document.getElementById('c1_temp').value);const baro=document.getElementById('c1_baro').value;const sky=document.getElementById('c1_sky').value;const wind=parseFloat(document.getElementById('c1_wind').value);const precip=document.getElementById('c1_precip').value;const season=document.getElementById('c1_season').value;const tod=document.getElementById('c1_tod').value;const windward=document.getElementById('c1_windward').checked;const res=baseScore(sp,temp,baro,sky,wind,precip,season,tod,windward);showScore('c1',res.score,res.lines);});
document.getElementById('c2_calc').addEventListener('click',()=>{const water=document.getElementById('c2_water').value;const sp=document.getElementById('c2_species').value;const temp=parseFloat(document.getElementById('c2_temp').value);const baro=document.getElementById('c2_baro').value;const sky=document.getElementById('c2_sky').value;const wind=parseFloat(document.getElementById('c2_wind').value);const precip=document.getElementById('c2_precip').value;const season=document.getElementById('c2_season').value;const tod=document.getElementById('c2_tod').value;const windward=document.getElementById('c2_windward').checked;const res=baseScore(sp,temp,baro,sky,wind,precip,season,tod,windward);const adj=withWaterbody(sp,water,res.score,season);res.lines.push(`Waterbody prevalence (${water}): ${(adj-res.score>=0?'+':'')}${(adj-res.score)}`);showScore('c2',adj,res.lines);});
async function fetchOM(lat,lon){const tz=Intl.DateTimeFormat().resolvedOptions().timeZone;const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation,cloud_cover,wind_speed_10m,surface_pressure&timezone=${encodeURIComponent(tz)}`;const r=await fetch(url);if(!r.ok)throw new Error('Forecast fetch failed');return r.json();}
function classifyBaroTrend(pressures){const n=pressures.length;if(n<12)return"stable";const avg=a=>a.reduce((x,y)=>x+y,0)/a.length;const prev=avg(pressures.slice(0,6));const next=avg(pressures.slice(6,12));const diff=next-prev;if(diff<=-3)return"rapid_falling";if(diff<-1.5)return"falling";if(diff>3)return"rapid_rising";if(diff>1.5)return"rising";return"stable";}
function skyFromClouds(cc,tod){if(tod==="dawn"||tod==="dusk")return"dawn_dusk";if(cc>=70)return"overcast";if(cc<=30&&tod==="midday")return"sunny_midday";return"mixed";}
function precipClass(mm){if(mm>=5)return"heavy";if(mm>0)return"light";return"none";}
function seasonFromDate(d){const m=d.getMonth()+1;if(m>=4&&m<=5)return"spring";if(m>=6&&m<=8)return"summer";if(m>=9&&m<=11)return"fall";return"winter";}
function formatSlot(h){return (h<12?(h===0?"12am":h+"am"):(h===12?"12pm":(h-12)+"pm"));}
async function checkForecast(){const threshold=parseInt(document.getElementById('threshold').value||"65",10);const list=document.getElementById('out_list');list.innerHTML='<li>Fetching forecasts…</li>';const now=new Date();const tomorrow=new Date(now.getTime()+24*3600*1000);const seasonTomorrow=seasonFromDate(tomorrow);const topHits=[];for(const [name,lat,lon] of WATERS){try{const data=await fetchOM(lat,lon);const H=data.hourly;const len=H.time.length;const baroTrend=classifyBaroTrend(H.surface_pressure.slice(0,12));const tStr=tomorrow.toISOString().slice(0,10);const slots=[];for(let i=0;i<len;i++){if(H.time[i].startsWith(tStr+'T06:00'))slots.push(i);if(H.time[i].startsWith(tStr+'T12:00'))slots.push(i);if(H.time[i].startsWith(tStr+'T18:00'))slots.push(i);}if(slots.length===0)slots.push(30,36,42);const speciesList=["bass","walleye","trout","pike","perch"];for(const idx of slots){const tempF=(H.temperature_2m[idx]*9/5)+32;const wind=H.wind_speed_10m[idx];const clouds=H.cloud_cover[idx];const precip=H.precipitation[idx];const hourISO=H.time[idx];const hourLocal=new Date(hourISO);const hr=hourLocal.getHours();const tod=(hr<=7)?"dawn":(hr<=11)?"morning":(hr<=16)?"midday":(hr<=19)?"evening":"dusk";const sky=skyFromClouds(clouds,tod);const pclass=precipClass(precip);for(const sp of speciesList){const base=baseScore(sp,tempF,baroTrend,sky,wind,pclass,seasonTomorrow,tod,true).score;const adj=withWaterbody(sp,name,base,seasonTomorrow);if(adj>=threshold){topHits.push({name,sp,hour:hr,score:adj});}}}}catch(e){console.error(name,e);}}
topHits.sort((a,b)=>b.score-a.score);list.innerHTML='';if(topHits.length===0){const li=document.createElement('li');li.textContent=`No scores ≥ ${threshold} in tomorrow’s key windows.`;list.appendChild(li);}else{topHits.slice(0,10).forEach(hit=>{const li=document.createElement('li');li.textContent=`${hit.name} — ${hit.sp} at ${formatSlot(hit.hour)} → ${hit.score}`;list.appendChild(li);});}}
function addCalendarReminder(){const now=new Date();const dtstamp=now.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';const start=new Date();start.setHours(19,0,0,0);const DTSTART=start.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z';const uid=Math.random().toString(36).slice(2)+"@bite";const ics=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Bite Likelihood//EN
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${dtstamp}
DTSTART:${DTSTART}
RRULE:FREQ=DAILY
SUMMARY:Check Bite Likelihood (tap link)
DESCRIPTION:Open the Bite app and run Forecast & Alerts → Check.
URL:https://app.local/index.html
END:VEVENT
END:VCALENDAR`;const blob=new Blob([ics],{type:'text/calendar'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='bite_daily_reminder.ics';a.click();setTimeout(()=>URL.revokeObjectURL(url),2000);}
document.getElementById('checkNow').addEventListener('click',checkForecast);
document.getElementById('addCalendar').addEventListener('click',addCalendarReminder);
</script>
</body>
</html>