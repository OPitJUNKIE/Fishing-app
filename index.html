<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Fishing Bite Likelihood</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" href="bite_app_icon_512.png" type="image/png">
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { color: #2e6da4; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #f2f2f2; }
</style>
</head>
<body>
<h1>Fishing Bite Likelihood</h1>
<div id="results">Loading data...</div>
<script>
// ---- Waterbody Prevalence Factors (example values — update with your dataset) ----
const waterbodySpeciesFactors = {
  "Lake Ontario – Rochester shore": { bass: 1.0, walleye: 0.9, trout: 1.0, pike: 0.8, perch: 1.0 },
  "Irondequoit Bay": { bass: 1.1, walleye: 0.7, trout: 0.4, pike: 0.9, perch: 1.0 },
  "Genesee River – lower": { bass: 0.9, walleye: 0.8, trout: 0.6, pike: 0.7, perch: 0.9 },
  "Conesus Lake": { bass: 1.1, walleye: 0.8, trout: 0.3, pike: 0.0, perch: 1.0 },
  "Honeoye Lake": { bass: 1.2, walleye: 0.2, trout: 0.0, pike: 0.0, perch: 1.1 },
  "Hemlock Lake": { bass: 1.0, walleye: 0.3, trout: 1.0, pike: 0.0, perch: 0.8 },
  "Canadice Lake": { bass: 0.9, walleye: 0.3, trout: 1.0, pike: 0.0, perch: 0.7 }
};

// ---- Species Weather Sensitivity ----
const speciesWeatherSensitivity = {
  bass: { temp: [60, 80], windMax: 15 },
  walleye: { temp: [55, 75], windMax: 20 },
  trout: { temp: [50, 65], windMax: 15 },
  pike: { temp: [55, 70], windMax: 18 },
  perch: { temp: [50, 70], windMax: 15 }
};

// ---- Lunar Bonus Function ----
function lunarBonus(moonPhase, moonrise, moonset, time) {
  let bonus = 0;
  // Phase weighting
  if (moonPhase < 0.1 || moonPhase > 0.9) { // New Moon
    bonus += 4; 
  } else if (Math.abs(moonPhase - 0.5) < 0.1) { // Full Moon
    bonus += 4;
  } else if (Math.abs(moonPhase - 0.25) < 0.1 || Math.abs(moonPhase - 0.75) < 0.1) { // Quarters
    bonus += 2;
  } else {
    bonus += 1;
  }
  // Minor periods: moonrise/set ± 60 min
  const t = time.getTime();
  if (Math.abs(t - moonrise.getTime()) <= 60*60*1000 ||
      Math.abs(t - moonset.getTime()) <= 60*60*1000) {
    bonus += 6;
  }
  return bonus;
}

// ---- Scoring Function ----
function computeScore(species, waterbody, temp, wind, cloud, precip, moonPhase, moonrise, moonset, time) {
  let baseScore = 50;
  // Temperature
  const [optLow, optHigh] = speciesWeatherSensitivity[species].temp;
  if (temp >= optLow && temp <= optHigh) baseScore += 10;
  // Wind penalty
  if (wind > speciesWeatherSensitivity[species].windMax) baseScore -= 10;
  // Clouds
  if (cloud > 50) baseScore += 5;
  // Precipitation
  if (precip > 0 && precip < 3) baseScore += 3;
  // Waterbody prevalence
  baseScore *= waterbodySpeciesFactors[waterbody][species];
  // Lunar effect
  baseScore += lunarBonus(moonPhase, moonrise, moonset, time);
  return Math.round(baseScore);
}

// ---- Main Fetch ----
(async function(){
  const resultsDiv = document.getElementById("results");
  try {
    const lat = 43.1656, lon = -77.6114;
    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,windspeed_10m,cloudcover,precipitation,moon_phase,moonrise,moonset&timezone=auto`);
    const weatherData = await weatherRes.json();

    const hours = weatherData.hourly.time.map((t, i) => ({
      time: new Date(t),
      temp: weatherData.hourly.temperature_2m[i],
      wind: weatherData.hourly.windspeed_10m[i],
      cloud: weatherData.hourly.cloudcover[i],
      precip: weatherData.hourly.precipitation[i],
      moonPhase: weatherData.hourly.moon_phase[i],
      moonrise: new Date(weatherData.hourly.moonrise[0]),
      moonset: new Date(weatherData.hourly.moonset[0])
    }));

    let alerts = [];
    let tableHTML = "<table><tr><th>Time</th><th>Waterbody</th><th>Species</th><th>Score</th></tr>";
    for (const h of hours) {
      for (const waterbody in waterbodySpeciesFactors) {
        for (const species in speciesWeatherSensitivity) {
          const score = computeScore(species, waterbody, h.temp, h.wind, h.cloud, h.precip, h.moonPhase, h.moonrise, h.moonset, h.time);
          tableHTML += `<tr><td>${h.time.toLocaleString()}</td><td>${waterbody}</td><td>${species}</td><td>${score}</td></tr>`;
          if (score >= 65) {
            alerts.push({ score, waterbody, species, time: h.time });
          }
        }
      }
    }
    tableHTML += "</table>";
    resultsDiv.innerHTML = tableHTML;

    if (alerts.length > 0) {
      alerts.sort((a,b) => b.score - a.score);
      const topAlerts = alerts.slice(0, 3);
      alert("Bite Alerts:\n" + topAlerts.map(a => `${a.species} in ${a.waterbody} at ${a.time.toLocaleTimeString()} — Score ${a.score}`).join("\n"));
    }
  } catch (err) {
    resultsDiv.textContent = "Error loading data: " + err;
  }
})();
</script>
</body>
</html>
